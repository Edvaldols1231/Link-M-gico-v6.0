<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkMágico v6.0 + v7.0 Integrado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: white;
        }

        /* Header com tema dark */
        .header {
            text-align: center;
            padding: 2rem 1rem;
            position: relative;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(0, 255, 136, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .logo {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 1rem;
            border-radius: 15px;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        /* Tema dark para seções */
        .section {
            background: linear-gradient(145deg, #2c3e50, #34495e);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .section h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #ecf0f1;
        }

        .section p {
            opacity: 0.8;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            color: #bdc3c7;
        }

        /* Formulário com tema dark */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #ecf0f1;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
            outline: none;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            margin: 0.5rem;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
        }

        .btn-info {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        /* Analytics com tema dark */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .analytics-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #00ff88, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .analytics-label {
            opacity: 0.7;
            font-size: 0.9rem;
            color: #bdc3c7;
        }

        /* Preview do chatbot melhorado */
        .chat-preview {
            background: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-preview h4 {
            margin-bottom: 1rem;
            color: #ecf0f1;
        }

        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
        }

        .chat-message {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 0.8rem;
            border-radius: 15px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            animation: slideInLeft 0.5s ease-out;
        }

        .chat-message.user {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            margin-left: 2rem;
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.8rem;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
        }

        .chat-input button {
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            cursor: pointer;
        }

        /* Botões sociais - layout original com logos */
        .social-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .social-btn {
            padding: 0.8rem;
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            border: 2px solid transparent;
        }

        .social-btn:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Cores originais dos botões sociais */
        .whatsapp { background: linear-gradient(45deg, #25d366, #128c7e); }
        .telegram { background: linear-gradient(45deg, #0088cc, #005580); }
        .facebook { background: linear-gradient(45deg, #1877f2, #166fe5); }
        .youtube { background: linear-gradient(45deg, #ff0000, #cc0000); }
        .tiktok { background: linear-gradient(45deg, #000000, #333333); }
        .twitter { background: linear-gradient(45deg, #1da1f2, #0d8bd9); }
        .instagram { background: linear-gradient(45deg, #e1306c, #fd1d1d, #f77737, #fcaf45); }
        .linkedin { background: linear-gradient(45deg, #0077b5, #005885); }
        .messenger { background: linear-gradient(45deg, #006aff, #0053d1); }
        .prompt { background: linear-gradient(45deg, #00ff88, #00cc6a); color: #000; }
        .analytics { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        .kwai { background: linear-gradient(45deg, #ff6600, #e55a00); }

        /* Widget code com tema dark */
        .widget-code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            margin-top: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Seção v7.0 com tema dark atrativo */
        .v7-features {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 2rem;
            margin: 3rem 0;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .v7-features h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #ecf0f1;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .feature-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .feature-card h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #ecf0f1;
        }

        .feature-card p {
            margin-bottom: 1.5rem;
            opacity: 0.8;
            color: #bdc3c7;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse 1s infinite;
        }

        /* Estados dos botões */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '⏳';
            margin-left: 0.5rem;
        }

        .success {
            background: linear-gradient(45deg, #00ff88, #00cc6a) !important;
            color: #000 !important;
        }

        .error {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Alert messages */
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid;
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            color: #00ff88;
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
            color: #3498db;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .social-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="version-badge">🆕 NOVA VERSÃO v6.0 + v7.0 INTEGRADA</div>
        
        <div class="logo-container">
            <div class="logo">🤖</div>
            <div>
                <h1>LinkMágico v6.0</h1>
                <div class="subtitle">
                    <span class="status-indicator"></span>
                    IA Conversacional Inteligente + Demos Públicos
                </div>
            </div>
            <div style="position: absolute; top: 1rem; right: 2rem; background: rgba(0, 0, 0, 0.3); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                <span class="status-indicator"></span>Sistema Online
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Alerts para feedback -->
        <div id="alertContainer"></div>

        <!-- Grid principal -->
        <div class="main-grid">
            <!-- Seção Criar Chatbot -->
            <div class="section">
                <h2>🤖 Criar Chatbot</h2>
                <p>Configure seu assistente de vendas inteligente</p>
                
                <div class="form-group">
                    <label>👤 Nome do Assistente Virtual:</label>
                    <input type="text" id="robotName" placeholder="@convertamaisleads" value="@convertamaisleads">
                </div>
                
                <div class="form-group">
                    <label>🔗 URL da Página:</label>
                    <input type="url" id="pageUrl" placeholder="https://drmonteze.com.br/produto-programamonteze/">
                </div>
                
                <div class="form-group">
                    <label>💡 Instruções Personalizadas (opcional):</label>
                    <textarea id="instructions" rows="4" placeholder="Mostre empatia genuína (&quot;Entendo perfeitamente a sua dúvida.&quot;) e seja consultivo, amigável e motivador, como um vendedor que guia o cliente.">Mostre empatia genuína ("Entendo perfeitamente a sua dúvida.") e seja consultivo, amigável e motivador, como um vendedor que guia o cliente.</textarea>
                    <small style="opacity: 0.7; color: #bdc3c7;">Dica: para respostas curtas (2-3 frases), objetivas e sem repetições.</small>
                </div>
                
                <button type="button" class="btn" id="createChatbotBtn" onclick="createChatbot()">
                    🚀 Ativar Chatbot Inteligente
                </button>

                <!-- Resultado da extração -->
                <div id="extractionResult" style="display: none; margin-top: 1rem;">
                    <div class="alert alert-success">
                        <strong>✅ Dados Extraídos com Sucesso!</strong>
                        <div id="extractedContent" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>
                </div>

                <!-- Botões Sociais com Logos -->
                <div class="social-buttons">
                    <a href="#" class="social-btn whatsapp" onclick="shareToSocial('whatsapp')">
                        <span style="font-size: 1.2rem;">📱</span>
                        WhatsApp
                    </a>
                    <a href="#" class="social-btn telegram" onclick="shareToSocial('telegram')">
                        <span style="font-size: 1.2rem;">✈️</span>
                        Telegram
                    </a>
                    <a href="#" class="social-btn facebook" onclick="shareToSocial('facebook')">
                        <span style="font-size: 1.2rem;">📘</span>
                        Facebook
                    </a>
                    <a href="#" class="social-btn youtube" onclick="shareToSocial('youtube')">
                        <span style="font-size: 1.2rem;">📺</span>
                        YouTube
                    </a>
                    <a href="#" class="social-btn tiktok" onclick="shareToSocial('tiktok')">
                        <span style="font-size: 1.2rem;">🎵</span>
                        TikTok
                    </a>
                    <a href="#" class="social-btn twitter" onclick="shareToSocial('twitter')">
                        <span style="font-size: 1.2rem;">🐦</span>
                        Twitter
                    </a>
                    <a href="#" class="social-btn instagram" onclick="shareToSocial('instagram')">
                        <span style="font-size: 1.2rem;">📷</span>
                        Instagram
                    </a>
                    <a href="#" class="social-btn linkedin" onclick="shareToSocial('linkedin')">
                        <span style="font-size: 1.2rem;">💼</span>
                        LinkedIn
                    </a>
                    <a href="#" class="social-btn messenger" onclick="shareToSocial('messenger')">
                        <span style="font-size: 1.2rem;">💬</span>
                        Messenger
                    </a>
                    <a href="#" class="social-btn prompt" onclick="shareToSocial('prompt')">
                        <span style="font-size: 1.2rem;">🤖</span>
                        Prompt
                    </a>
                    <a href="#" class="social-btn analytics" onclick="openAnalytics()">
                        <span style="font-size: 1.2rem;">📊</span>
                        Analytics
                    </a>
                    <a href="#" class="social-btn kwai" onclick="shareToSocial('kwai')">
                        <span style="font-size: 1.2rem;">📱</span>
                        Kwai
                    </a>
                </div>
            </div>

            <!-- Dashboard Analytics -->
            <div class="section">
                <h2>📊 Dashboard Analytics</h2>
                <p>Acompanhe o desempenho do seu chatbot em tempo real</p>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="botsCount">147</div>
                        <div class="analytics-label">👤 Chatbots Criados hoje</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="messagesCount">8967</div>
                        <div class="analytics-label">💬 Mensagens enviadas</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value">100%</div>
                        <div class="analytics-label">📊 Extração de dados</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="responseTime">2s</div>
                        <div class="analytics-label">⚡ Tempo de resposta</div>
                    </div>
                </div>

                <!-- Preview do Chatbot Funcional -->
                <div class="chat-preview">
                    <h4>💬 Preview do Chatbot</h4>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message">
                            🤖 Olá! Sou seu assistente especializado. Como posso te ajudar hoje?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="previewInput" placeholder="Digite sua pergunta...">
                        <button onclick="sendPreviewMessage()">Enviar</button>
                    </div>
                </div>

                <!-- Widget Embed Code -->
                <div style="margin-top: 2rem;">
                    <h4>🔧 Widget Embed Code</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; color: #bdc3c7;">Cole este código em qualquer site para adicionar o chatbot flutuante:</p>
                    <div class="widget-code" id="widgetCode">
&lt;!-- LinkMágico Chatbot Widget --&gt;
&lt;script&gt;
(function() {
  var config = {
    robotName: '<span id="widgetRobotName">Seu Assistente</span>',
    apiBase: 'https://link-m-gico-v6-0-dx0q.onrender.com'
  };
  var script = document.createElement('script');
  script.src = 'https://link-m-gico-v6-0-dx0q.onrender.com/widget.js';
  script.onload = function() {
    window.LinkMagicoWidget.init(config);
  };
  document.head.appendChild(script);
})();
&lt;/script&gt;
                    </div>
                </div>
            </div>
        </div>

        <!-- SEÇÃO v7.0 com tema dark atrativo -->
        <div class="v7-features">
            <h2>🆕 Funcionalidades v7.0 Integradas</h2>
            <p>Explore as novas funcionalidades públicas e recursos avançados</p>
            
            <div class="features-grid">
                <div class="feature-card">
                    <h3>📊 Dashboard Demo</h3>
                    <p>Analytics público em tempo real com dados simulados para demonstração</p>
                    <a href="/dashboard/demo" class="btn btn-info" target="_blank">
                        🎯 Acessar Dashboard Demo
                    </a>
                </div>
                
                <div class="feature-card">
                    <h3>🔧 Widget Demo</h3>
                    <p>Demonstração completa do widget embedável com chat funcional</p>
                    <a href="/widget/demo" class="btn btn-warning" target="_blank">
                        💬 Testar Widget Demo
                    </a>
                </div>
                
                <div class="feature-card">
                    <h3>📖 Documentação</h3>
                    <p>Guia completo de APIs, exemplos de integração e configuração</p>
                    <a href="/docs" class="btn btn-secondary" target="_blank">
                        📚 Ver Documentação
                    </a>
                </div>
                
                <div class="feature-card">
                    <h3>🔍 Status APIs</h3>
                    <p>Monitoramento em tempo real das APIs GROQ, OpenAI e OpenRouter</p>
                    <a href="/status" class="btn btn-info" target="_blank">
                        📡 Verificar Status
                    </a>
                </div>
            </div>

            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 15px;">
                <h4>🎯 Sistema de IA com Fallback Automático</h4>
                <div style="display: flex; justify-content: center; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
                    <span style="background: linear-gradient(45deg, #00ff88, #00cc6a); color: #000; padding: 0.5rem 1rem; border-radius: 15px;">1º GROQ API</span>
                    <span style="background: linear-gradient(45deg, #3498db, #2980b9); padding: 0.5rem 1rem; border-radius: 15px;">2º OpenAI API</span>
                    <span style="background: linear-gradient(45deg, #f39c12, #e67e22); padding: 0.5rem 1rem; border-radius: 15px;">3º OpenRouter API</span>
                    <span style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); padding: 0.5rem 1rem; border-radius: 15px;">4º Sistema Nativo</span>
                </div>
                <p style="font-size: 0.9rem; opacity: 0.9; color: #bdc3c7;">✅ Rate Limiting Ativo | ✅ Logging Estruturado | ✅ 99% Uptime</p>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let botCount = 147;
        let messageCount = 8967;
        let currentExtractedData = null;

        // Função para mostrar alertas
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove após 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
            
            // Scroll para o alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Função principal para criar chatbot - VERSÃO ROBUSTA
        async function createChatbot() {
            const robotName = document.getElementById('robotName').value || '@convertamaisleads';
            const pageUrl = document.getElementById('pageUrl').value;
            const instructions = document.getElementById('instructions').value;
            const btn = document.getElementById('createChatbotBtn');

            console.log('🚀 Iniciando criação do chatbot...');
            console.log('📝 Dados:', { robotName, pageUrl, instructions });

            if (!pageUrl) {
                showAlert('❌ Por favor, insira a URL da página para extrair os dados.', 'error');
                return;
            }

            // Validar URL
            try {
                new URL(pageUrl);
            } catch (e) {
                showAlert('❌ URL inválida. Use o formato: https://exemplo.com', 'error');
                return;
            }

            // Estado de loading
            btn.classList.add('loading');
            btn.textContent = '🔄 Extraindo dados da página...';
            btn.disabled = true;

            try {
                // PASSO 1: Extrair dados da página
                console.log('🔍 Tentando extrair dados de:', pageUrl);
                showAlert('🔍 Extraindo dados da página... Aguarde!', 'info');

                const extractResponse = await fetch('/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: pageUrl }),
                    timeout: 15000
                });

                console.log('📡 Resposta da extração:', extractResponse.status);

                if (!extractResponse.ok) {
                    const errorText = await extractResponse.text();
                    console.error('❌ Erro na extração:', errorText);
                    throw new Error(`Erro ${extractResponse.status}: ${errorText}`);
                }

                const extractData = await extractResponse.json();
                console.log('✅ Dados extraídos:', extractData);

                if (extractData.success && extractData.data) {
                    currentExtractedData = extractData.data;
                    
                    // Mostrar dados extraídos
                    const resultDiv = document.getElementById('extractionResult');
                    const contentDiv = document.getElementById('extractedContent');
                    
                    contentDiv.innerHTML = `
                        <div><strong>📄 Título:</strong> ${extractData.data.title}</div>
                        <div><strong>📝 Descrição:</strong> ${extractData.data.description}</div>
                        <div><strong>📊 Conteúdo extraído:</strong> ${extractData.data.content.length} caracteres</div>
                    `;
                    resultDiv.style.display = 'block';

                    // Atualizar código do widget
                    document.getElementById('widgetRobotName').textContent = robotName;
                    
                    showAlert('✅ Dados extraídos com sucesso! Configurando IA...', 'success');

                    // PASSO 2: Testar chat com dados extraídos
                    btn.textContent = '🤖 Configurando IA...';
                    
                    const testMessage = "Olá! Como você pode me ajudar?";
                    console.log('🤖 Testando chat com IA...');

                    const chatResponse = await fetch('/chat-universal', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: testMessage,
                            robotName: robotName,
                            instructions: instructions,
                            extractedData: currentExtractedData
                        }),
                        timeout: 10000
                    });

                    console.log('🤖 Resposta do chat:', chatResponse.status);

                    if (chatResponse.ok) {
                        const chatData = await chatResponse.json();
                        console.log('✅ Chat funcionando:', chatData);
                        
                        // Adicionar resposta ao preview
                        const messagesDiv = document.getElementById('chatMessages');
                        if (chatData.success && chatData.response) {
                            messagesDiv.innerHTML += `
                                <div class="chat-message user">${testMessage}</div>
                                <div class="chat-message">${chatData.response}</div>
                            `;
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                            
                            showAlert('🎉 Chatbot ativado com sucesso! IA respondendo perfeitamente!', 'success');
                        } else if (chatData.fallbackResponse) {
                            messagesDiv.innerHTML += `
                                <div class="chat-message user">${testMessage}</div>
                                <div class="chat-message">${chatData.fallbackResponse}</div>
                            `;
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                            
                            showAlert('⚠️ Chatbot ativado com resposta de fallback. Verifique as APIs.', 'info');
                        }
                    } else {
                        console.warn('⚠️ Chat API não respondeu corretamente');
                        showAlert('⚠️ IA configurada, mas teste de chat falhou. Chatbot ainda pode funcionar.', 'info');
                    }

                    // SUCESSO FINAL
                    btn.classList.remove('loading');
                    btn.classList.add('success');
                    btn.textContent = '✅ Chatbot Ativado com Sucesso!';
                    
                    // Incrementar contador
                    botCount++;
                    document.getElementById('botsCount').textContent = botCount;
                    
                    // Salvar no localStorage
                    localStorage.setItem('linkmagico_lastSuccess', JSON.stringify({
                        robotName,
                        pageUrl,
                        instructions,
                        timestamp: new Date().toISOString()
                    }));

                } else {
                    throw new Error('Dados não foram extraídos corretamente da página');
                }

            } catch (error) {
                console.error('❌ Erro completo:', error);
                
                btn.classList.remove('loading');
                btn.classList.add('error');
                btn.textContent = '❌ Erro na criação';
                
                let errorMessage = '❌ Erro na criação do chatbot:<br>';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += '🌐 <strong>Problema de conexão.</strong><br>';
                    errorMessage += '• Verifique sua internet<br>';
                    errorMessage += '• O servidor pode estar reiniciando<br>';
                    errorMessage += '• Tente novamente em 30 segundos';
                } else if (error.message.includes('404')) {
                    errorMessage += '🔍 <strong>Página não encontrada.</strong><br>';
                    errorMessage += '• Verifique se a URL está correta<br>';
                    errorMessage += '• A página deve estar online';
                } else if (error.message.includes('500')) {
                    errorMessage += '⚙️ <strong>Erro no servidor.</strong><br>';
                    errorMessage += '• Problema temporário nas APIs<br>';
                    errorMessage += '• Tente novamente em alguns minutos';
                } else {
                    errorMessage += `🔧 <strong>Detalhes:</strong> ${error.message}`;
                }
                
                showAlert(errorMessage, 'error');
            }

            // Resetar botão após 3 segundos
            setTimeout(() => {
                btn.classList.remove('loading', 'success', 'error');
                btn.textContent = '🚀 Ativar Chatbot Inteligente';
                btn.disabled = false;
            }, 3000);
        }

        // Função para enviar mensagem no preview - VERSÃO ROBUSTA
        async function sendPreviewMessage() {
            const input = document.getElementById('previewInput');
            const message = input.value.trim();
            
            if (!message) {
                showAlert('💬 Digite uma mensagem para testar o chat!', 'info');
                return;
            }
            
            const messagesDiv = document.getElementById('chatMessages');
            const robotName = document.getElementById('robotName').value || 'Assistente';
            const instructions = document.getElementById('instructions').value;
            
            // Adicionar mensagem do usuário
            messagesDiv.innerHTML += `<div class="chat-message user">${message}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Limpar input
            input.value = '';
            
            // Mostrar typing
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message';
            typingDiv.id = 'typing';
            typingDiv.innerHTML = '🤖 Digitando...';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                console.log('💬 Enviando mensagem para chat:', message);
                
                const response = await fetch('/chat-universal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        robotName: robotName,
                        instructions: instructions,
                        extractedData: currentExtractedData
                    }),
                    timeout: 10000
                });

                // Remover typing
                typingDiv.remove();

                console.log('💬 Resposta do chat:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Dados do chat:', data);
                    
                    if (data.success && data.response) {
                        messagesDiv.innerHTML += `<div class="chat-message">${data.response}</div>`;
                        
                        // Incrementar contador de mensagens
                        messageCount++;
                        document.getElementById('messagesCount').textContent = messageCount;
                        
                        showAlert('✅ IA respondeu com sucesso!', 'success');
                    } else if (data.fallbackResponse) {
                        messagesDiv.innerHTML += `<div class="chat-message">${data.fallbackResponse}</div>`;
                        showAlert('⚠️ Resposta de fallback utilizada.', 'info');
                    } else {
                        messagesDiv.innerHTML += `<div class="chat-message">❌ Resposta não disponível no momento.</div>`;
                        showAlert('❌ Erro na resposta da IA.', 'error');
                    }
                } else {
                    messagesDiv.innerHTML += `<div class="chat-message">❌ Erro de conexão com a IA. Tente novamente.</div>`;
                    showAlert('❌ Erro de conexão. Verifique se o servidor está online.', 'error');
                }

            } catch (error) {
                console.error('💬 Erro no chat:', error);
                typingDiv?.remove();
                messagesDiv.innerHTML += `<div class="chat-message">❌ Erro: ${error.message}</div>`;
                showAlert('❌ Erro na comunicação com a IA. Tente novamente.', 'error');
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Função para compartilhamento social
        function shareToSocial(platform) {
            const pageUrl = document.getElementById('pageUrl').value || window.location.href;
            const robotName = document.getElementById('robotName').value || 'LinkMágico';
            
            const urls = {
                whatsapp: `https://api.whatsapp.com/send?text=Conheça o ${robotName} - IA Conversacional: ${pageUrl}`,
                telegram: `https://t.me/share/url?url=${pageUrl}&text=${robotName} - IA Conversacional`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${pageUrl}`,
                youtube: 'https://studio.youtube.com',
                tiktok: 'https://www.tiktok.com/upload',
                twitter: `https://twitter.com/intent/tweet?text=Conheça o ${robotName}&url=${pageUrl}`,
                instagram: 'https://www.instagram.com',
                linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${pageUrl}`,
                messenger: `https://www.messenger.com/t/?link=${pageUrl}`,
                prompt: '/docs#prompts',
                kwai: 'https://www.kwai.com'
            };

            if (urls[platform]) {
                try {
                    window.open(urls[platform], '_blank', 'noopener,noreferrer');
                    showAlert(`📱 Abrindo ${platform.charAt(0).toUpperCase() + platform.slice(1)}...`, 'info');
                } catch (error) {
                    window.location.href = urls[platform];
                }
            }
        }

        // Função para abrir analytics
        function openAnalytics() {
            window.open('/dashboard/demo', '_blank');
            showAlert('📊 Abrindo Dashboard Analytics...', 'info');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 LinkMágico v6.0 + v7.0 inicializado');
            
            // Enter no preview do chat
            document.getElementById('previewInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendPreviewMessage();
                }
            });
            
            // Auto-save dos campos
            const autoSave = () => {
                const data = {
                    robotName: document.getElementById('robotName').value,
                    pageUrl: document.getElementById('pageUrl').value,
                    instructions: document.getElementById('instructions').value
                };
                localStorage.setItem('linkmagico_form', JSON.stringify(data));
            };

            // Auto-load dos campos
            const autoLoad = () => {
                const saved = localStorage.getItem('linkmagico_form');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.robotName) document.getElementById('robotName').value = data.robotName;
                    if (data.pageUrl) document.getElementById('pageUrl').value = data.pageUrl;
                    if (data.instructions) document.getElementById('instructions').value = data.instructions;
                }
            };

            // Event listeners para auto-save
            document.getElementById('robotName').addEventListener('input', autoSave);
            document.getElementById('pageUrl').addEventListener('input', autoSave);
            document.getElementById('instructions').addEventListener('input', autoSave);

            // Carregar dados salvos
            autoLoad();

            // Verificar status das APIs
            checkAPIStatus();
            
            // Focar no primeiro campo vazio
            if (!document.getElementById('robotName').value) {
                document.getElementById('robotName').focus();
            } else if (!document.getElementById('pageUrl').value) {
                document.getElementById('pageUrl').focus();
            }
        });

        // Verificar status das APIs
        async function checkAPIStatus() {
            try {
                console.log('🔍 Verificando status das APIs...');
                const response = await fetch('/status', { timeout: 5000 });
                const data = await response.json();
                console.log('📊 Status das APIs:', data);
                
                // Atualizar indicadores visuais
                const indicators = document.querySelectorAll('.status-indicator');
                indicators.forEach(indicator => {
                    indicator.style.background = '#00ff88';
                    indicator.style.boxShadow = '0 0 10px #00ff88';
                });
                
                showAlert('✅ Sistema online! Todas as APIs funcionando.', 'success');
                
            } catch (error) {
                console.warn('⚠️ Status das APIs indisponível:', error);
                
                // Indicador de warning
                const indicators = document.querySelectorAll('.status-indicator');
                indicators.forEach(indicator => {
                    indicator.style.background = '#f39c12';
                    indicator.style.boxShadow = '0 0 10px #f39c12';
                });
                
                showAlert('⚠️ Verificação de status falhou. Sistema pode estar reiniciando.', 'info');
            }
        }

        // Atualizar contadores em tempo real
        setInterval(() => {
            if (Math.random() > 0.8) {
                messageCount += Math.floor(Math.random() * 2) + 1;
                document.getElementById('messagesCount').textContent = messageCount;
                
                // Simular tempo de resposta variável
                const times = ['1s', '2s', '3s', '2s', '1s'];
                document.getElementById('responseTime').textContent = times[Math.floor(Math.random() * times.length)];
            }
        }, 8000);

        // Debug helper
        window.debugLinkMagico = function() {
            console.log('🔍 Debug Info:');
            console.log('Current extracted data:', currentExtractedData);
            console.log('Bot count:', botCount);
            console.log('Message count:', messageCount);
            console.log('Form data:', {
                robotName: document.getElementById('robotName').value,
                pageUrl: document.getElementById('pageUrl').value,
                instructions: document.getElementById('instructions').value
            });
        };

        console.log('🎉 LinkMágico carregado! Digite debugLinkMagico() no console para debug.');
    </script>
</body>
</html>